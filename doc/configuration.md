# DnsCollector Configuration Guide

- [Trace](#Trace)
- [Collectors](#Collectors)
  - [DNStap](#Dnstap)
  - [Sniffer](#Sniffer)
  - [GeoIP Support](#GeoIP-Support)
- [Loggers](#Loggers)
  - [Stdout](#Stdout)
  - [Build-in Webserver](#Build-in-Webserver)
  - [Log File](#Log-File)
  - [DNStap](#Dnstap-Logger)
  - [JSON tcp](#JSON-TCP)
  - [Syslog](#Syslog)

See [config](https://github.com/dmachard/go-dnscollector/blob/main/config.yml) file.

## Trace

Logs can be enable to have more informations like debug, errors messages generated by th application

```yaml
# If turned on, log some applications messages
trace:
  # debug informations
  verbose: true
  # filename is the file to write logs to.
  filename: ""
  # maximum size in megabytes of the log file it gets rotated
  max-size: 10
  # maximum number of old log files to retain
  max-backups: 10
```

Example:

```
INFO: 2021/08/12 07:10:12.347913 main - config loaded...
INFO: 2021/08/12 07:10:12.347957 main - starting dnscollector...
INFO: 2021/08/12 07:10:12.347964 generator webserver - enabled
INFO: 2021/08/12 07:10:12.347992 generator stdout logging - enabled
INFO: 2021/08/12 07:10:12.348023 collector dns sniffer - enabled
INFO: 2021/08/12 07:10:12.348318 main - running all collectors and generators...
INFO: 2021/08/12 07:10:12.348442 generator webserver - running in background...
INFO: 2021/08/12 07:10:12.348482 generator webserver - starting http api...
INFO: 2021/08/12 07:10:12.348775 generator stdout - running in background...
INFO: 2021/08/12 07:10:12.348793 generator webserver - is listening on [::]:8080
INFO: 2021/08/12 07:10:12.362156 dns processor - initialization...
INFO: 2021/08/12 07:10:12.362313 dns processor - ready
INFO: 2021/08/12 07:10:12.362372 processor dns parser - running... waiting incoming dns message
```

## Collectors

### DNStap

Dnstap stream collector tcp or unix socket with tls support.

```yaml
dnstap:
  # to enable, set the enable to true
  enable: false
  # listen on ip
  listen-ip: 0.0.0.0
  # listening on port
  listen-port: 6000
  # unix socket path
  sock-path: null
  # tls support
  tls-support: false
  # certificate server file
  cert-file: ""
  # private key server file
  key-file: ""
```

### Sniffer

Raw DNS packets sniffer. Setting `CAP_NET_RAW` capabilities on executables allows you to run these 
program without having to run-it with the root user.

```
sudo setcap cap_net_admin,cap_net_raw=eip go-dnscollector
```

Enable the sniffer

```yaml
dns-sniffer:
  enable: true
  port: 53
  device: ""
  identity: dnscollector
  record-dns-queries: true
  record-dns-replies: true
```

### GeoIP Support

The country code can be populated regarding the query IP collected.
To enable this feature, you need to configure the path to your database.

See [Downloads](https://www.maxmind.com/en/accounts/current/geoip/downloads) maxmind page to get the database.

```yaml
processors:
  # geoip maxmind support
  geoip:
    # path file to your database
    db-file: ""
```

When the feature is enable, tne `country-isocode` field is populated with the country code.

```json
{
  "operation": "AUTH_RESPONSE",
  "query-ip": "127.0.126.114",
  ...
  "country-isocode":"FR"
}
```

## Loggers

### Stdout

Print to your standard output, all DNS logs received in text or json format

```yaml
stdout:
  enable: false
  mode: text
```

Example:

**Text**

```
2021-08-07T15:33:15.168298439Z dnscollector CLIENT_QUERY NOERROR 10.0.0.210 32918 INET UDP 54b www.google.fr A 0.000000
2021-08-07T15:33:15.457492773Z dnscollector CLIENT_RESPONSE NOERROR 10.0.0.210 32918 INET UDP 152b www.google.fr A 0.28919
```

**JSON**

```json
{
  "operation": "CLIENT_RESPONSE",
  "identiy": "dnscollector",
  "family": "INET",
  "protocol": "UDP",
  "query-ip": "10.0.0.51",
  "query-port": "47789",
  "response-ip": "10.0.0.2",
  "response-port": "53",
  "length": 60,
  "rcode": "NOERROR",
  "qname": "play.google.com",
  "qtype": "A",
  "latency": "0.004502",
  "timestamp-rfc3339": "2021-08-07T15:31:56.572064655Z",
  "answers": [
    {
      "name": "play.google.com",
      "rdatatype": "A",
      "ttl": 0,
      "rdata": "142.250.185.110"
    }
  ],
  "country-isocode":"-"
}
```

### Build-in Webserver

Build-in webserver to retrieve somes statistics like top domains, clients and more...
Basic authentication supported.

```yaml
webserver:
  # to enable, set the enable to true
  enable: true
  # listening IP
  listen-ip: 0.0.0.0
  # listening port
  listen-port: 8080
  # default number of items to return
  top-max-items: 100
  # default login
  basic-auth-login: admin
  # default password
  basic-auth-pwd: changeme
  # tls support
  tls-support: true
  # certificate server file
  cert-file: "./testsdata/server.crt"
  # private key server file
  key-file: "./testsdata/server.key"
  # prometheus suffix
  prometheus-suffix: "dnscollector"
```


### Log File

Enable this logger if you want to log to a file.

```yaml
logfile:
  enable: false
  file-path: null
  max-size: 100
  max-files: 10
  log-queries: true
  log-replies: true
```

### DNStap Logger

DNStap stream logger to a remote tcp destination or unix socket.

```yaml
dnstap-tcp:
  enable: false
  remote-ip: 10.0.0.1
  remote-port: 6000
  sock-path: null
  retry: 5
  dnstap-identity: dnscollector
```

### JSON tcp

JSON tcp stream logger.

```yaml
json-tcp:
  enable: true
  remote-ip: 127.0.0.1
  remote-port: 9999
  retry-interval: 5
```

Example:

```json
{
  "operation": "AUTH_RESPONSE",
  "identiy": "dnstap-logger",
  "family": "INET",
  "protocol": "DOH",
  "query-ip": "127.0.126.114",
  "query-port": "42978",
  "response-ip": "127.0.240.58",
  "response-port": "53",
  "length": 160,
  "rcode": "NOERROR",
  "qname": "mondomaine.fr",
  "qtype": "A",
  "latency": "0.000011",
  "timestamp-rfc3339": "2021-07-31T18:16:46.068840539Z",
  "resource-records": [
    {
      "name": "mondomaine.fr",
      "rdatatype": "A",
      "ttl": 3600,
      "rdata": "127.0.0.1"
    }
  ],
  "country-isocode":"-"
}
```

### Syslog

```yaml
syslog:
  # to enable, set the enable to true
  enable: false
  # Set the syslog logging severity 
  severity: INFO
  # Set the syslog logging facility 
  facility: DAEMON
  # Transport to use to a remote log daemon or local one
  # local|tcp|udp|unix
  transport: local
  # Remote address host:port
  remote-address: ""
```