# DnsCollector Configuration Guide

- [Trace](#Trace)
- [Collectors](#Collectors)
  - [DNS tap](#Dnstap)
  - [DNS sniffer](#Dns-Sniffer)
  - [Tail](#Tail)
- [Subprocessors](#Subprocessors)
  - [Qname lowercase](#Qname-lowercase)
  - [IP anonymization](#Ip-Anonymization)
  - [GeoIP Support](#GeoIP-Support)
  - [DNS Caching](#DNS-Caching)
  - [Packet Filtering](#Packet-Filtering)
  - [Custom text format](#Custom-Text-Format)
  - [Statistics](#Statistics)
- [Loggers](#Loggers)
  - [Stdout](#Stdout)
  - [REST API](#REST-API)
  - [Log File](#Log-File)
  - [DNStap](#Dnstap-Logger)
  - [TCP](#TCP-Client)
  - [Syslog](#Syslog)
  - [Fluentd](#Fluentd-Client)
  - [Pcap File](#Pcap-File)

See [config](https://github.com/dmachard/go-dnscollector/blob/main/config.yml) file.

## Trace

Logs can be enable to have more informations like debug, errors messages generated by th application

```yaml
# If turned on, log some applications messages
trace:
  # debug informations
  verbose: true
  # filename is the file to write logs to.
  filename: ""
  # maximum size in megabytes of the log file it gets rotated
  max-size: 10
  # maximum number of old log files to retain
  max-backups: 10
```

Example:

```
INFO: 2021/08/12 07:10:12.347913 main - config loaded...
INFO: 2021/08/12 07:10:12.347957 main - starting dnscollector...
INFO: 2021/08/12 07:10:12.347964 generator webserver - enabled
INFO: 2021/08/12 07:10:12.347992 generator stdout logging - enabled
INFO: 2021/08/12 07:10:12.348023 collector dns sniffer - enabled
INFO: 2021/08/12 07:10:12.348318 main - running all collectors and generators...
INFO: 2021/08/12 07:10:12.348442 generator webserver - running in background...
INFO: 2021/08/12 07:10:12.348482 generator webserver - starting http api...
INFO: 2021/08/12 07:10:12.348775 generator stdout - running in background...
INFO: 2021/08/12 07:10:12.348793 generator webserver - is listening on [::]:8080
INFO: 2021/08/12 07:10:12.362156 dns processor - initialization...
INFO: 2021/08/12 07:10:12.362313 dns processor - ready
INFO: 2021/08/12 07:10:12.362372 processor dns parser - running... waiting incoming dns message
```

## Collectors

### DNS tap

Dnstap stream collector tcp or unix socket with tls support.

```yaml
dnstap:
  # to enable, set the enable to true
  enable: false
  # listen on ip
  listen-ip: 0.0.0.0
  # listening on port
  listen-port: 6000
  # unix socket path
  sock-path: null
  # tls support
  tls-support: false
  # certificate server file
  cert-file: ""
  # private key server file
  key-file: ""
```

### DNS sniffer

Raw DNS packets sniffer. Setting `CAP_NET_RAW` capabilities on executables allows you to run these 
program without having to run-it with the root user.

```
sudo setcap cap_net_admin,cap_net_raw=eip go-dnscollector
```

Enable the sniffer

```yaml
dns-sniffer:
  # to enable, set the enable to true
  enable: true
  # filter on source and destination port
  port: 53
  # if "" bind on all interfaces
  device: wlp2s0
  # capture dns queries
  capture-dns-queries: true
  # capture dns replies
  capture-dns-replies: true
```

## Tail

The tail collector enable to read DNS event from text files.
DNS servers log server can be followed; any type of server is supported.

Enable the tail by provided the path of the file to follow

```yaml
tail:
  # to enable, set the enable to true
  enable: false
  # file to follow
  file-path: null
  # Use the exact layout numbers described https://golang.org/src/time/format.go
  time-layout: "2006-01-02T15:04:05.999999999Z07:00"
  # regexp pattern for queries
  # example for unbound: "query: (?P<queryip>[^ ]*) (?P<domain>[^ ]*) (?P<qtype>[^ ]*)"
  pattern-query: "^(?P<timestamp>[^ ]*) (?P<identity>[^ ]*) (?P<qr>.*_QUERY) (?P<rcode>[^ ]*) (?P<queryip>[^ ]*) (?P<queryport>[^ ]*) (?P<family>[^ ]*) (?P<protocol>[^ ]*) (?P<length>[^ ]*)b (?P<domain>[^ ]*) (?P<qtype>[^ ]*) (?P<latency>[^ ]*)$"
  # regexp pattern for replies
  # example for unbound: "reply: (?P<queryip>[^ ]*) (?P<domain>[^ ]*) (?P<qtype>[^ ]*) IN (?P<rcode>[^ ]*) (?P<latency>[^ ]*)"
  pattern-reply: "^(?P<timestamp>[^ ]*) (?P<identity>[^ ]*) (?P<qr>.*_RESPONSE) (?P<rcode>[^ ]*) (?P<queryip>[^ ]*) (?P<queryport>[^ ]*) (?P<family>[^ ]*) (?P<protocol>[^ ]*) (?P<length>[^ ]*)b (?P<domain>[^ ]*) (?P<qtype>[^ ]*) (?P<latency>[^ ]*)$"
```

## Subprocessors

### Qname lowercase

Option to convert all domain to lowercase.
This feature is enabled by default.

```yaml
subprocessors:
  # Convert all domain to lowercase
  qname-lowercase: true
```

### IP Anonymization

This feature can be used to anonymize all IP queries.
For example, QueryIP 8.8.8.8 will be replaced by 8.8.0.0.

```yaml
subprocessors:
  # IP-Addresses are anonymities by zeroing the host-part of an address.
  anonymize-ip: false
```

### GeoIP Support

The country code can be populated regarding the query IP collected.
To enable this feature, you need to configure the path to your database.

See [Downloads](https://www.maxmind.com/en/accounts/current/geoip/downloads) maxmind page to get the database.

```yaml
subprocessors:
  # geoip maxmind support
  geoip:
    # path file to your database
    db-file: "/GeoLite2-Country.mmdb"
```

When the feature is enable, the `country-isocode` field is populated with the country code.

```json
{
  "operation": "AUTH_RESPONSE",
  "query-ip": "127.0.126.114",
  "country-isocode":"FR"
}
```

### DNS Caching

The caching feature is used to compute latency between replies and queries.

```yaml
subprocessors:
  # The cache is used to compute latency between replies and queries
  # Ttl in second 
  cache-ttl: 10
```

### Packet Filtering

This feature can be use to ignore somes qnames.

```yaml
subprocessors:
  filtering:
    # regexp to ignore incoming qname
    ignore-qname: ""
    # send queries to configured loggers or or not
    log-queries: true
    # send replies to configured loggers or not
    log-replies: true 
```

### Custom text format

```yaml
subprocessors:
  # specific the default text log format used on all loggers supporting this mode
  # all available directives:
  # - timestamp: timestamp rfc3339 format, with nano support
  # - identity: dnstap identity
  # - qr: query or reply flag
  # - operation: dnstap operation
  # - rcode: dns return code
  # - queryip: dns query ip
  # - queryport: dns query port
  # - responseip: dns response ip
  # - responseport: dns response port
  # - id: dns id
  # - family: ip protocol version INET or INET6
  # - protocol: protocol UDP, TCP
  # - length: the length of the query or reply
  # - qtype: dns qtype
  # - qname: dns qname
  # - latency: computed latency between queries and replies
  # - answercount: the number of answer
  # - country: country iso code
  # - ttl: answer ttl
  text-format: "timestamp identity qr operation rcode queryip queryport family protocol length qname qtype latency ttl"
```

### Statistics

Some options to customize the statitics subprocessor.

```yaml
subprocessors:
  # Statistics engine
  statistics:
    # default number of items on top 
    top-max-items: 100
    # expected common qtype list, other will be considered as suspicious
    common-qtypes:
      - A
      - AAAA
      - CNAME
      - TXT
      - PTR
      - NAPTR
      - DNSKEY
      - SRV
    # a length greater than this value will be considered as suspicious
    threshold-qname-len: 80
    # a size greater than this value will be considered as suspicious
    # value in bytes
    threshold-packet-len: 1000
    # threshold to set a domain considered as slow, value in second
    threshold-slow: 0.5
```

## Loggers

### Stdout

Print to your standard output, all DNS logs received in text or json format

```yaml
stdout:
  # to enable, set the enable to true
  enable: true
  # text|json
  mode: text
  # output text format, please refer to the default text format to see all available directives 
  # use this parameter if you want a specific format
  text-format: ""
```

Example:

**Text**

```
2021-08-07T15:33:15.168298439Z dnscollector CLIENT_QUERY NOERROR 10.0.0.210 32918 INET UDP 54b www.google.fr A 0.000000
2021-08-07T15:33:15.457492773Z dnscollector CLIENT_RESPONSE NOERROR 10.0.0.210 32918 INET UDP 152b www.google.fr A 0.28919
```

**JSON**

```json
{
  "operation": "CLIENT_RESPONSE",
  "identiy": "dnscollector",
  "family": "INET",
  "protocol": "UDP",
  "query-ip": "10.0.0.51",
  "query-port": "47789",
  "response-ip": "10.0.0.2",
  "response-port": "53",
  "length": 60,
  "rcode": "NOERROR",
  "qname": "play.google.com",
  "qtype": "A",
  "latency": "0.004502",
  "timestamp-rfc3339": "2021-08-07T15:31:56.572064655Z",
  "answers": [
    {
      "name": "play.google.com",
      "rdatatype": "A",
      "ttl": 0,
      "rdata": "142.250.185.110"
    }
  ],
  "country-isocode":"-"
}
```

### REST API

Build-in webserver with REST API to retrieve somes statistics like top domains, clients and more...
Basic authentication supported. Prometheus metrics is also available through this API.

See the [swagger](swagger.yml) documentation.

```yaml
webserver:
  # to enable, set the enable to true
  enable: true
  # listening IP
  listen-ip: 0.0.0.0
  # listening port
  listen-port: 8080
  # default login
  basic-auth-login: admin
  # default password
  basic-auth-pwd: changeme
  # tls support
  tls-support: true
  # certificate server file
  cert-file: "./testsdata/server.crt"
  # private key server file
  key-file: "./testsdata/server.key"
  # prometheus suffix
  prometheus-suffix: "dnscollector"
```

**Prometheus metrics example:**

Request:

```
$ curl --user admin:changeme http://127.0.0.1:8080/metrics
```

The full metrics can be found [here](doc/metrics.txt).


### Log File

Enable this logger if you want to log to a file. Rotation files is supported.

```yaml
logfile:
  # to enable, set the enable to true
  enable: false
  # output logfile name
  file-path: null
  # maximum size in megabytes of the file before rotation
  # A minimum of max-size*max-files megabytes of space disk must be available
  max-size: 100
  # maximum number of files to retain.
  # Set to zero if you want to disable this feature
  max-files: 10
  # flush buffer to log file every X seconds
  flush-interval: 10
  # compress log file
  compress: false
  # compress interval
  # checking every X seconds if new log files must be compressed
  compress-interval: 5
  # output format: text|json
  mode: text
  # output text format, please refer to the default text format to see all available directives 
  # use this parameter if you want a specific format
  text-format: ""
  # run external script
  postrotate-command: null
  # delete file on script success
  postrotate-delete-success: false
```

### DNStap

DNStap stream logger to a remote tcp destination or unix socket.

```yaml
dnstap:
  # to enable, set the enable to true
  enable: false
    # remote address
  remote-address: 10.0.0.1
  # remote tcp port
  remote-port: 6000
  # unix socket path
  sock-path: null
  # interval in second between retry reconnect
  retry-interval: 5
  # enable tls
  tls-support: false
  # insecure skip verify
  tls-insecure: false
```

### TCP Client

Tcp/unix stream client logger.

```yaml
tcpclient:
  # to enable, set the enable to true
    enable: false
    # network transport to use: tcp|unix
    transport: tcp
    # remote address
    remote-address: 127.0.0.1
    # remote tcp port
    remote-port: 9999
    # unix socket path
    sock-path: null
    # interval in second between retry reconnect
    retry-interval: 5
    # enable tls
    tls-support: false
    # insecure skip verify
    tls-insecure: false
    # output format: text|json
    mode: json
    # output text format, please refer to the default text format to see all available directives 
    # use this parameter if you want a specific format
    text-format: ""
```

Example:

```json
{
  "operation": "AUTH_RESPONSE",
  "identiy": "dnstap-logger",
  "family": "INET",
  "protocol": "DOH",
  "query-ip": "127.0.126.114",
  "query-port": "42978",
  "response-ip": "127.0.240.58",
  "response-port": "53",
  "length": 160,
  "rcode": "NOERROR",
  "qname": "mondomaine.fr",
  "qtype": "A",
  "latency": "0.000011",
  "timestamp-rfc3339": "2021-07-31T18:16:46.068840539Z",
  "resource-records": [
    {
      "name": "mondomaine.fr",
      "rdatatype": "A",
      "ttl": 3600,
      "rdata": "127.0.0.1"
    }
  ],
  "country-isocode":"-"
}
```

### Syslog

Syslog logger to local syslog system or remote one.

```yaml
syslog:
  # to enable, set the enable to true
  enable: false
  # Set the syslog logging severity 
  severity: INFO
  # Set the syslog logging facility 
  facility: DAEMON
  # Transport to use to a remote log daemon or local one
  # local|tcp|udp|unix
  transport: local
  # Remote address host:port
  remote-address: ""
  # output text format, please refer to the default text format to see all available directives 
  # use this parameter if you want a specific format
  text-format: ""
  # output format: text|json
  mode: text
```

### Fluentd Client

Fluentd client to remote server or unix socket.

```yaml
fluentd:
    # to enable, set the enable to true
    enable: true
    # network transport to use: tcp|unix
    transport: tcp
    # remote address
    remote-address: 127.0.0.1
    # remote tcp port
    remote-port: 24224
    # unix socket path
    sock-path: null
    # interval in second between retry reconnect
    retry-interval: 5
    # tag name
    tag: "dns.collector"
    # enable tls
    tls-support: false
    # insecure skip verify
    tls-insecure: false
```

### Pcap File

Enable this logger if you want to log into a pcap file.

```yaml
pcapfile:
  # to enable, set the enable to true
  enable: false
  # output logfile name
  file-path: null
  # maximum size in megabytes of the file before rotation
  max-size: 1
  # maximum number of files to retain.
  max-files: 3
  # compress pcap file
  compress: false
  # compress interval
  # checking every X seconds if new log files must be compressed
  compress-interval: 5
  # run external script after each file rotation
  postrotate-command: null
  # delete file on script success
  postrotate-delete-success: true
```